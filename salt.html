// salt.js - 3D/AR просмотрщик для ARTANAT

// Конфигурация моделей (добавляйте новые модели по этому образцу)
const MODEL_DATABASE = {
    "salt автор1": {
        glb: "https://github.com/Ill-27/at1828nat/blob/6ba3ea0b27f9e7850ff7f60a9bd2d332e6c0d9a5/models/Lanki_art_1.glb",
        title: "Кристалл соли",
        description: "Автор: автор1 | Минеральная структура в 3D",
        category: "minerals"
    },
    "crystal автор2": {
        glb: "https://raw.githubusercontent.com/username/repo/main/models/crystal.glb",
        title: "Алмазный кристалл",
        description: "Автор: автор2 | Кристаллическая решетка",
        category: "minerals"
    }
    // Добавляйте новые модели в формате: "название автор": { ... }
};

// Инициализация 3D просмотрщика
function init3DViewer() {
    // Создаем контейнер
    const container = document.createElement('div');
    container.id = '3d-viewer-container';
    container.style.cssText = `
        position: fixed; top: 0; left: 0; 
        width: 100%; height: 100%; 
        z-index: 9999; background: #000;
        display: none; flex-direction: column;
    `;
    
    // Панель информации
    const infoPanel = document.createElement('div');
    infoPanel.style.cssText = `
        padding: 15px; background: rgba(0,0,0,0.7);
        display: flex; justify-content: space-between;
        align-items: center; color: white;
        position: relative; z-index: 10000;
    `;
    
    const textContainer = document.createElement('div');
    
    const title = document.createElement('h2');
    title.id = 'model-title';
    title.style.margin = '0 0 5px 0';
    title.style.fontSize = '18px';
    
    const desc = document.createElement('p');
    desc.id = 'model-desc';
    desc.style.margin = '0';
    desc.style.fontSize = '14px';
    desc.style.opacity = '0.8';
    
    textContainer.appendChild(title);
    textContainer.appendChild(desc);
    
    // Кнопка закрытия
    const closeBtn = document.createElement('button');
    closeBtn.innerHTML = '&times; Закрыть';
    closeBtn.onclick = closeViewer;
    closeBtn.style.cssText = `
        padding: 8px 15px; background: rgba(255,0,0,0.3);
        border: 1px solid #ff4444; color: white; 
        cursor: pointer; border-radius: 4px;
        font-family: 'Fira Code', monospace;
    `;
    
    infoPanel.appendChild(textContainer);
    infoPanel.appendChild(closeBtn);
    container.appendChild(infoPanel);
    
    // Контейнер для модели
    const modelContainer = document.createElement('div');
    modelContainer.style.flex = '1';
    modelContainer.style.position = 'relative';
    container.appendChild(modelContainer);
    
    document.body.appendChild(container);
    
    // Обработчик клавиши ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeViewer();
    });
}

// Показывает модель
function showModel(modelData) {
    const container = document.getElementById('3d-viewer-container');
    const modelContainer = container.querySelector('div:last-child');
    
    // Очищаем предыдущую модель
    modelContainer.innerHTML = '';
    
    // Устанавливаем информацию
    document.getElementById('model-title').textContent = modelData.title;
    document.getElementById('model-desc').textContent = modelData.description;
    
    // Создаем model-viewer
    const modelViewer = document.createElement('model-viewer');
    modelViewer.style.width = '100%';
    modelViewer.style.height = '100%';
    modelViewer.src = modelData.glb;
    modelViewer.alt = modelData.title;
    modelViewer.ar = true;
    modelViewer.arScale = 'auto';
    modelViewer.cameraControls = true;
    modelViewer.autoRotate = true;
    modelViewer.style.backgroundColor = '#000';
    
    // Для iOS
    if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
        modelViewer.iosSrc = modelData.glb.replace('.glb', '.usdz');
        modelViewer.quickLookBrowsers = 'safari chrome';
    }
    
    // Прелоадер
    const progress = document.createElement('div');
    progress.style.cssText = `
        position: absolute; top: 50%; left: 50%;
        transform: translate(-50%, -50%); color: white;
        font-family: 'Fira Code', monospace;
    `;
    progress.textContent = 'Загрузка модели...';
    modelContainer.appendChild(progress);
    
    modelViewer.addEventListener('progress', (e) => {
        const percent = Math.round(e.detail.totalProgress * 100);
        progress.textContent = `Загрузка: ${percent}%`;
        if (percent === 100) setTimeout(() => progress.remove(), 500);
    });
    
    modelContainer.appendChild(modelViewer);
    container.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

// Закрывает просмотрщик
function closeViewer() {
    const container = document.getElementById('3d-viewer-container');
    if (!container) return;
    
    container.style.display = 'none';
    document.body.style.overflow = 'auto';
    
    // Освобождаем ресурсы
    const modelViewer = container.querySelector('model-viewer');
    if (modelViewer) {
        modelViewer.src = '';
        if (modelViewer.shadowRoot) {
            const video = modelViewer.shadowRoot.querySelector('video');
            if (video) video.pause();
        }
    }
}

// Модифицируем обработчик ввода
function setup3DViewer() {
    const originalSetupInput = window.setupInput;
    
    window.setupInput = function() {
        originalSetupInput();
        
        const input = document.getElementById('command-input');
        const output = document.getElementById('terminal-output');
        
        input.addEventListener('keypress', async function(e) {
            if (e.key === 'Enter') {
                const query = input.value.trim().toLowerCase();
                
                // Проверяем, есть ли модель с таким запросом
                if (MODEL_DATABASE[query]) {
                    const response = document.createElement('div');
                    output.appendChild(response);
                    await typeText(response, `> Загрузка "${MODEL_DATABASE[query].title}"...`);
                    
                    // Показываем модальное окно перед открытием 3D
                    const modal = document.getElementById('rules-modal');
                    const checkbox = document.getElementById('agree-checkbox');
                    const continueBtn = document.getElementById('continue-button');
                    
                    // Сбрасываем состояние
                    checkbox.checked = false;
                    continueBtn.disabled = true;
                    
                    // Обновляем обработчик
                    continueBtn.onclick = function() {
                        if (checkbox.checked) {
                            modal.style.display = 'none';
                            document.body.style.overflow = 'auto';
                            showModel(MODEL_DATABASE[query]);
                        }
                    };
                    
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                    
                    input.value = '';
                    return;
                }
            }
        });
    };
}

// Инициализация при загрузке
document.addEventListener('DOMContentLoaded', function() {
    init3DViewer();
    setup3DViewer();
});
