name: Obfuscate HTML
on: [push]

jobs:
  obfuscate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18
          
      - name: Install Obfuscator
        run: npm install javascript-obfuscator -g
        
      - name: Obfuscate HTML files
        run: |
          find . -name "bg*.html" -exec sh -c '
            echo "Обфускация $1 ..."
            # Извлекаем JavaScript из HTML
            js_code=$(sed -n "/<script>/,/<\/script>/p" "$1" | sed "1d;$ d")
            
            # Обфусцируем с максимальными настройками
            obfuscated=$(javascript-obfuscator --options-file ./obfuscator.json <<< "$js_code")
            
            # Собираем обратно в HTML
            awk -v code="$obfuscated" "
              /<script>/{print; print code; skip=1}
              /<\/script>/{skip=0}
              !skip && !/<script>/
            " "$1" > "$1.tmp"
            
            mv "$1.tmp" "$1"
          ' sh {} \;
          
      - name: Commit changes
        run: |
          git config --global user.name "GitHub Obfuscator"
          git config --global user.email "obfuscator@github.com"
          git add .
          git commit -m "Автоматическая обфускация кода"
          git push
